<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Clapping Asynchronously (CLI Applications With Futures)</title>
        
        <meta name="robots" content="noindex" />
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "light" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div id="sidebar-scrollbox" class="sidebar-scrollbox">
                <ol class="chapter"><li class="expanded affix "><a href="introduction.html">Introduction</a></li><li class="expanded "><a href="scenario.html"><strong aria-hidden="true">1.</strong> Scenario</a></li><li><ol class="section"><li class="expanded "><a href="scenario/minimum_viable_product.html"><strong aria-hidden="true">1.1.</strong> Minimum Viable Product</a></li><li class="expanded "><a href="scenario/vision.html"><strong aria-hidden="true">1.2.</strong> Vision</a></li><li class="expanded "><a href="scenario/quality_software.html"><strong aria-hidden="true">1.3.</strong> Quality Software</a></li></ol></li><li class="expanded "><a href="synchronous.html"><strong aria-hidden="true">2.</strong> Synchronous</a></li><li class="expanded "><a href="async.html"><strong aria-hidden="true">3.</strong> Async</a></li><li class="expanded "><a href="fast_food.html"><strong aria-hidden="true">4.</strong> Fast Food</a></li><li><ol class="section"><li class="expanded "><a href="fast_food/concurrency.html"><strong aria-hidden="true">4.1.</strong> Concurrency</a></li><li class="expanded "><a href="fast_food/parallelism.html"><strong aria-hidden="true">4.2.</strong> Parallelism</a></li><li class="expanded "><a href="fast_food/different_work.html"><strong aria-hidden="true">4.3.</strong> Different Work</a></li><li class="expanded "><a href="fast_food/who_does_what.html"><strong aria-hidden="true">4.4.</strong> Who Does What</a></li><li class="expanded "><a href="fast_food/task_organization.html"><strong aria-hidden="true">4.5.</strong> Task Organization</a></li><li class="expanded "><a href="fast_food/communicating.html"><strong aria-hidden="true">4.6.</strong> Communicating</a></li></ol></li><li class="expanded "><a href="asynchronous_design.html"><strong aria-hidden="true">5.</strong> Asynchronous Design</a></li><li><ol class="section"><li class="expanded "><a href="asynchronous_design/rushed_migration.html"><strong aria-hidden="true">5.1.</strong> Rushed Migration</a></li><li class="expanded "><a href="asynchronous_design/categorization_by_resource_use.html"><strong aria-hidden="true">5.2.</strong> Categorization By Resource Use</a></li><li class="expanded "><a href="asynchronous_design/information_flow.html"><strong aria-hidden="true">5.3.</strong> Information Flow</a></li></ol></li><li class="expanded "><a href="comparison.html"><strong aria-hidden="true">6.</strong> Comparison</a></li><li class="expanded "><a href="review.html"><strong aria-hidden="true">7.</strong> Review</a></li><li class="spacer"></li><li class="expanded affix "><a href="links.html">Links</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar" class="menu-bar">
                    <div id="menu-bar-sticky-container">
                        <div class="left-buttons">
                            <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                                <i class="fa fa-bars"></i>
                            </button>
                            <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                                <i class="fa fa-paint-brush"></i>
                            </button>
                            <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                                <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                            </ul>
                            
                            <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                                <i class="fa fa-search"></i>
                            </button>
                            
                        </div>

                        <h1 class="menu-title">Clapping Asynchronously (CLI Applications With Futures)</h1>

                        <div class="right-buttons">
                            <a href="print.html" title="Print this book" aria-label="Print this book">
                                <i id="print-button" class="fa fa-print"></i>
                            </a>
                            
                        </div>
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#introduction" id="introduction">Introduction</a></h1>
<p>Providing good user experience (UX) for a command line application can be tricky.</p>
<p>This book shows how such an application can be designed using the <code>async</code> programming paradigm.</p>
<hr />
<p>Written for the Rust Auckland meetup 2020-02-03.</p>
<ul>
<li>Rust Auckland meetup: <a href="https://www.meetup.com/rust-akl/">https://www.meetup.com/rust-akl/</a></li>
<li>Slack: <a href="https://rust-akl.slack.com/messages/CCC7KUXMY/">https://rust-akl.slack.com/messages/CCC7KUXMY/</a></li>
<li>Repository: <a href="https://github.com/azriel91/clapping_asynchronously">https://github.com/azriel91/clapping_asynchronously</a></li>
</ul>
<p>Feel free to use and improve on these.</p>
<h1><a class="header" href="#scenario" id="scenario">Scenario</a></h1>
<p>A client has a list of property title numbers and owners. Each title number is associated with additional information -- address, sales information, and phone number.</p>
<p>However, the additional information is stored in a separate place, and requires authentication to access.</p>
<p>Your job is to merge all of the information into the same list.</p>
<p>Concretely, turn this:</p>
<table><thead><tr><th>Property Title</th><th>Owners</th><th>Address</th><th>Phone Number</th><th>Last Sale</th></tr></thead><tbody>
<tr><td><code>AA1234/01</code></td><td>John Smith, Mary Smith</td><td></td><td></td><td></td></tr>
<tr><td><code>BB5678/02</code></td><td>John Doe</td><td></td><td></td><td></td></tr>
<tr><td><code>..</code></td><td>..</td><td></td><td></td><td></td></tr>
</tbody></table>
<p>Into this:</p>
<table><thead><tr><th>Property Title</th><th>Owners</th><th>Address</th><th>Phone Number</th><th>Last Sale</th></tr></thead><tbody>
<tr><td><code>AA1234/01</code></td><td>John Smith, Mary Smith</td><td>123 Something Street, Somewhere</td><td>123-4567</td><td>1997</td></tr>
<tr><td><code>BB5678/02</code></td><td>John Doe</td><td>456 Another Street, Somewhere Else</td><td><em>missing</em></td><td>2002</td></tr>
<tr><td><code>..</code></td><td>..</td><td>..</td><td>..</td><td>..</td></tr>
</tbody></table>
<h1><a class="header" href="#minimum-viable-product" id="minimum-viable-product">Minimum Viable Product</a></h1>
<p>The smallest application that does the job:</p>
<ol>
<li>Read credentials.</li>
<li>Read property title records.</li>
</ol>
<p>For each record:</p>
<ol start="3">
<li>Authenticate with server.</li>
<li>Retrieve information.</li>
<li>Augment record.</li>
<li>Output record to file.</li>
</ol>
<h2><a class="header" href="#example" id="example">Example</a></h2>
<div><video controls src="minimum_viable_product.mp4" /></div>
<h1><a class="header" href="#vision" id="vision">Vision</a></h1>
<h2><a class="header" href="#interrupt-handling" id="interrupt-handling">Interrupt Handling</a></h2>
<div><video controls src="vision/pstitle_final_interrupt.mp4" /></div>
<h2><a class="header" href="#execution-report" id="execution-report">Execution Report</a></h2>
<div><video controls src="vision/pstitle_final_test.mp4" /></div>
<h2><a class="header" href="#cross-platform" id="cross-platform">Cross Platform</a></h2>
<p><img src="scenario/vision/pstitle_powershell.png" alt="" /></p>
<h1><a class="header" href="#quality-software" id="quality-software">Quality Software</a></h1>
<table><thead><tr><th>Minimum Viable Product</th><th>Quality Product</th></tr></thead><tbody>
<tr><td></td><td>0. Handle interruptions.</td></tr>
<tr><td>1. Read credentials.</td><td>1. Read credentials.</td></tr>
<tr><td>2. Read property title records.</td><td>2. Stream property title records.</td></tr>
<tr><td></td><td>3. Read output file for processed records.</td></tr>
<tr><td></td><td>4. Start progress bar.</td></tr>
<tr><td><strong>For each record:</strong></td><td><strong>For each record:</strong></td></tr>
<tr><td></td><td>5. Rate limit requests -- don't overload server.</td></tr>
<tr><td>3. Authenticate with server.</td><td>6. Authenticate with server if necessary.</td></tr>
<tr><td>4. Retrieve information.</td><td>7. Retrieve information.</td></tr>
<tr><td>5. Augment record.</td><td>8. Augment record.</td></tr>
<tr><td>6. Output record to file.</td><td>9. Output record to file.</td></tr>
<tr><td></td><td>10. Update progress bar.</td></tr>
<tr><td></td><td><strong>When interrupted, or done:</strong></td></tr>
<tr><td></td><td>11. Output execution report.</td></tr>
</tbody></table>
<h1><a class="header" href="#synchronous" id="synchronous">Synchronous</a></h1>
<p>The quality product can be implemented synchronously.</p>
<table><thead><tr><th>Quality Product</th></tr></thead><tbody>
<tr><td>0. Handle interruptions.</td></tr>
<tr><td>1. Read credentials.</td></tr>
<tr><td>2. Stream property title records.</td></tr>
<tr><td>3. Read output file for processed records.</td></tr>
<tr><td>4. Start progress bar.</td></tr>
<tr><td><strong>For each record:</strong></td></tr>
<tr><td>5. Rate limit requests -- don't overload server.</td></tr>
<tr><td>6. Authenticate with server if necessary.</td></tr>
<tr><td>7. Retrieve information.</td></tr>
<tr><td>8. Augment record.</td></tr>
<tr><td>9. Output record to file.</td></tr>
<tr><td>10. Update progress bar.</td></tr>
<tr><td><strong>When interrupted, or done:</strong></td></tr>
<tr><td>11. Output execution report.</td></tr>
</tbody></table>
<p>In code (<a href="https://github.com/azriel91/cli_async/blob/sync/src/main.rs#L119">source</a>):</p>
<pre><code class="language-rust ignore">fn main() {
    // ..
    let interrupt_rx =         t00_setup_interrupt_handler();
    let credentials =          t01_read_credentials();
    let records =              t02_stream_property_title_records(record_count);
    let records_precompleted = t03_read_output_file(skip);

    t04_start_progress_bar(&amp;mut reporter);

    let _result = records
        // ..
        .map(|(n, record)| {
            t05_rate_limit_requests(delay_rate_limit);
            t06_authenticate_with_server(n == 0, credentials, delay_auth);
            t07_retrieve_information(n, record, delay_retrieve);
            t08_augment_record(record, info)
        })
        .try_for_each(|property_record_populated| {
            t09_output_record_to_file(property_record_populated);
            t10_update_progress_bar(&amp;mut reporter);
        });

    t11_output_execution_report(&amp;reporter);
}
</code></pre>
<p>Demo:</p>
<pre><code class="language-bash">git clone git@github.com:azriel91/cli_async.git
cd cli_async
git worktree add ./sync sync
cd sync
cargo build --release
time ./target/release/cli_async -c 100 --delay-rate-limit 0 --delay-retrieve 1
</code></pre>
<h1><a class="header" href="#async" id="async">Async</a></h1>
<p>The quality product can be implemented <em>async</em>hronously.</p>
<table><thead><tr><th>Quality Product</th></tr></thead><tbody>
<tr><td>0. Handle interruptions.</td></tr>
<tr><td>1. Read credentials.</td></tr>
<tr><td>2. Stream property title records.</td></tr>
<tr><td>3. Read output file for processed records.</td></tr>
<tr><td>4. Start progress bar.</td></tr>
<tr><td><strong>For each record:</strong></td></tr>
<tr><td>5. Rate limit requests -- don't overload server.</td></tr>
<tr><td>6. Authenticate with server if necessary.</td></tr>
<tr><td>7. Retrieve information.</td></tr>
<tr><td>8. Augment record.</td></tr>
<tr><td>9. Output record to file.</td></tr>
<tr><td>10. Update progress bar.</td></tr>
<tr><td><strong>When interrupted, or done:</strong></td></tr>
<tr><td>11. Output execution report.</td></tr>
</tbody></table>
<p>In code (<a href="https://github.com/azriel91/cli_async/blob/async_one/src/main.rs#L116">source</a>):</p>
<blockquote>
<p><strong>⚠️ DO NOT USE THIS AS A REFERENCE IMPLEMENTATION</strong></p>
</blockquote>
<ul>
<li>Add <code>async</code> to functions and blocks.</li>
<li>Add <code>.await</code> to function calls.</li>
<li>Spawn tasks.</li>
</ul>
<pre><code class="language-rust ignore">#[tokio::main]
async fn main() -&gt; Result&lt;(), ()&gt; {
    // ..

    let (ctrl_c_future, interrupt_rx) = t00_setup_interrupt_handler();
    let credentials =                   t01_read_credentials();
    let records =                       t02_stream_property_title_records(record_count);
    let records_precompleted =          t03_read_output_file(skip);

    t04_start_progress_bar(&amp;mut reporter);

    let reporter_future = async move {
        t10_update_progress_bar(&amp;mut reporter).await;
        t11_output_execution_report(&amp;reporter);
    };

    let processing_future = async move {
        tokio::stream::iter(records)
            .then(move |(n, record)| async move {
                t05_rate_limit_requests(delay_rate_limit).await;
                t06_authenticate_with_server(n == 0, credentials, delay_auth).await;
                t07_retrieve_information(n, record, delay_retrieve).await;
                t08_augment_record(record, info)
            })
            .try_for_each_concurrent(10, move |property_record_populated| async move {
                t09_output_record_to_file(property_record_populated).await;
            })
            .await
    };

    let reporter_handle =   tokio::spawn(reporter_future);

    let ctrl_c_handle =     tokio::spawn(ctrl_c_future);
    let processing_handle = tokio::spawn(processing_future);

    let processed_or_interrupted = async {
        tokio::select! {
            _ = ctrl_c_handle =&gt; {}
            _ = processing_handle =&gt; {}
        }
    };

    let (_, _) = tokio::join!(reporter_handle, processed_or_interrupted);
}
</code></pre>
<p>Demo:</p>
<pre><code class="language-bash">git clone git@github.com:azriel91/cli_async.git
cd cli_async
git worktree add ./async_one async_one
cd async_one
cargo build --release
time ./target/release/cli_async -c 100 --delay-rate-limit 0 --delay-retrieve 1
</code></pre>
<h1><a class="header" href="#fast-food" id="fast-food">Fast Food</a></h1>
<p>Consider a fast food restaurant taking orders:</p>
<p><img src="fast_food/queue.png" alt="" /></p>
<p>A simple, but low throughput method to handle orders is:</p>
<ol>
<li>Accept order from customer 1.</li>
<li>Request order 1 to be made.</li>
<li>Wait for order 1 to be completed.</li>
<li>Give order 1 to customer 1.</li>
</ol>
<p>Then,</p>
<ol start="5">
<li>Accept order from customer 2.</li>
<li>Request order 2 to be made.</li>
<li>Wait for order 2 to be completed.</li>
<li>Give order 2 to customer 2.</li>
</ol>
<p>We can increase throughput of taking and completing orders through concurrency and parallelism.</p>
<h1><a class="header" href="#concurrency" id="concurrency">Concurrency</a></h1>
<ul>
<li>Workers can handle another customer's order while waiting for an earlier one to proceed.</li>
<li>More efficient use of existing resources.</li>
</ul>
<p><img src="fast_food/concurrency/concurrency.png" alt="" /></p>
<p>During the waiting time of the first order, we can start processing the second order:</p>
<p><img src="fast_food/concurrency/concurrent_time.png" alt="" /></p>
<h1><a class="header" href="#parallelism" id="parallelism">Parallelism</a></h1>
<ul>
<li>Multiple workers handle customers' orders.</li>
<li>Uses more resources.</li>
</ul>
<p><img src="fast_food/parallelism/parallelism.png" alt="" /></p>
<p>During the waiting time of the first order, we can start processing the second order:</p>
<p><img src="fast_food/parallelism/parallel_time.png" alt="" /></p>
<h1><a class="header" href="#different-work" id="different-work">Different Work</a></h1>
<blockquote>
<p>One Request, Multiple Tasks</p>
</blockquote>
<p><img src="fast_food/different_work/different_work.png" alt="" /></p>
<p>There are many steps needed to be done to complete one customer order.</p>
<p>For any worker that takes orders, their task is to:</p>
<ol>
<li>Receive the order.</li>
<li>Request the kitchen to process the order.</li>
<li>Take the processed order and return it to the customer.</li>
</ol>
<p>In the kitchen, the task is to:</p>
<ol>
<li>Receive the order request.</li>
<li>Prepare the order.</li>
<li>Send it back to the counter.</li>
</ol>
<h1><a class="header" href="#who-does-what" id="who-does-what">Who Does What</a></h1>
<h2><a class="header" href="#mental-shift" id="mental-shift">Mental Shift</a></h2>
<p><img src="fast_food/different_work/different_work.png" alt="" /></p>
<p>Instead of:</p>
<blockquote>
<p>Some workers take orders. Other workers process them.</p>
</blockquote>
<p>Switch your mindset:</p>
<blockquote>
<ul>
<li>Taking orders is one kind of work.</li>
<li>Processing orders is another kind of work.</li>
<li>Available workers do any available work.</li>
</ul>
</blockquote>
<p>In this model, with two workers:</p>
<ol>
<li>Worker A may take an order and send it for processing.</li>
<li>Worker B may finish processing an order and send it back to the counter.</li>
<li>Worker A may switch to do processing work, and receive its own request from step 1.</li>
</ol>
<h1><a class="header" href="#task-organization" id="task-organization">Task Organization</a></h1>
<p>When different kinds of tasks exist, we have organize them based on the resources they require.</p>
<p><img src="fast_food/./task_organization/task_organization.png" alt="" /></p>
<ul>
<li>
<p>New Task Per Request (Resource may be shared):</p>
<blockquote>
<p>&quot;Turn on a new stove top each time an order needs to be processed.&quot;</p>
</blockquote>
<ul>
<li>One person can turn on multiple stove tops (can be concurrent).</li>
<li>Two people can turn on stove tops (can be parallel).</li>
<li>Only possible when the resource is able to handle it.</li>
</ul>
</li>
<li>
<p>One Long-Lived Task (Resource is exclusive):</p>
<blockquote>
<p>&quot;The ice cream machine can only create one ice cream at a time.&quot;</p>
</blockquote>
<ul>
<li>One person can only make one ice cream at one time (cannot be concurrent).</li>
<li>Cannot have two people make one ice cream each (cannot be parallel).</li>
<li>Only one person has access to the ice cream machine.</li>
<li>The person who has access receives requests to make ice creams, and sends them back.</li>
</ul>
</li>
</ul>
<h1><a class="header" href="#communicating" id="communicating">Communicating</a></h1>
<p><img src="fast_food/communicating/communicating.png" alt="" /></p>
<p>When information needs to be passed between different types of work, it needs to be communicated.</p>
<ul>
<li>
<p>New Task Per Order</p>
<ul>
<li>Include information when creating the task.</li>
<li>Easy.</li>
</ul>
</li>
<li>
<p>Long-Lived Task</p>
<ul>
<li>Set up a communication channel.</li>
<li>Send information through the channel.</li>
</ul>
</li>
</ul>
<h1><a class="header" href="#asynchronous-design" id="asynchronous-design">Asynchronous Design</a></h1>
<p>It's cleaner to structure code for asynchronous execution by design, instead of by evolution.</p>
<ol>
<li>Categorization -- group logic by resource access.</li>
<li>Create information flow graph.</li>
<li>Write code.</li>
</ol>
<h1><a class="header" href="#rushed-migration" id="rushed-migration">Rushed Migration</a></h1>
<p>Hack approach (not necessarily recommended, but has its uses):</p>
<ul>
<li>
<p>Add <code>async</code> in front of <code>fn</code>s:</p>
<pre><code class="language-rust ignore">pub fn t07_retrieve_information(..)
pub async fn t07_retrieve_information(..)
</code></pre>
</li>
<li>
<p>Change synchronous logic to asynchronous logic:</p>
<pre><code class="language-rust ignore">std::thread::sleep(Duration::from_millis(delay));
tokio::time::delay_for(Duration::from_millis(delay)).await
</code></pre>
</li>
<li>
<p>Use types with asynchronous support:</p>
<pre><code class="language-rust ignore">// synchronous -- will idly wait when there are no messages.
let (tx, rx) = crossbeam::channel::unbounded::&lt;_&gt;();

// asynchronous -- will switch to a different task when there are no messages.
let (tx, rx) = tokio::sync::mpsc::unbounded_channel::&lt;_&gt;();
</code></pre>
</li>
<li>
<p>Swap understandable errors for impossible ones (<a href="https://github.com/tokio-rs/tokio/issues/1835">tokio#1835</a>):</p>
<pre><code class="language-rust ignore">    error[E0308]: mismatched types
  --&gt; src/main.rs:12:9
   |
12 |         tokio::spawn(async move {
   |         ^^^^^^^^^^^^ one type is more general than the other
   |
   = note: expected type `std::ops::FnOnce&lt;(std::iter::Map&lt;_&gt; + std::marker::Send&gt;&gt;,)&gt;`
              found type `std::ops::FnOnce&lt;(std::iter::Map&lt;_&gt; + std::marker::Send&gt;&gt;,)&gt;`

error: aborting due to previous error
</code></pre>
</li>
</ul>
<p>And I show you a still more excellent way.</p>
<h1><a class="header" href="#categorization-by-resource-use" id="categorization-by-resource-use">Categorization By Resource Use</a></h1>
<p>Steps are grouped into categories based on the data / resources it accesses. Each category is a kind of task.</p>
<table><thead><tr><th>Quality Product</th><th align="center">Input</th><th align="center">Processing</th><th align="center">Web</th><th align="center">Reporting</th></tr></thead><tbody>
<tr><td>0. Handle interruptions.</td><td align="center">✔️</td><td align="center"></td><td align="center"></td><td align="center"></td></tr>
<tr><td>1. Read credentials.</td><td align="center"></td><td align="center"></td><td align="center">✔️</td><td align="center"></td></tr>
<tr><td>2. Stream property title records.</td><td align="center"></td><td align="center">✔️</td><td align="center"></td><td align="center"></td></tr>
<tr><td>3. Read output file for processed records.</td><td align="center"></td><td align="center">✔️</td><td align="center"></td><td align="center"></td></tr>
<tr><td>4. Start progress bar.</td><td align="center"></td><td align="center"></td><td align="center"></td><td align="center">✔️</td></tr>
<tr><td><strong>For each record:</strong></td><td align="center"></td><td align="center"></td><td align="center"></td><td align="center"></td></tr>
<tr><td>5. Rate limit requests -- don't overload server.</td><td align="center"></td><td align="center"></td><td align="center">✔️</td><td align="center"></td></tr>
<tr><td>6. Authenticate with server if necessary.</td><td align="center"></td><td align="center"></td><td align="center">✔️</td><td align="center"></td></tr>
<tr><td>7. Retrieve information.</td><td align="center"></td><td align="center"></td><td align="center">✔️</td><td align="center"></td></tr>
<tr><td>8. Augment record.</td><td align="center"></td><td align="center">✔️</td><td align="center"></td><td align="center"></td></tr>
<tr><td>9. Output record to file.</td><td align="center"></td><td align="center">✔️</td><td align="center"></td><td align="center"></td></tr>
<tr><td>10. Update progress bar.</td><td align="center"></td><td align="center"></td><td align="center"></td><td align="center">✔️</td></tr>
<tr><td><strong>When interrupted, or done:</strong></td><td align="center"></td><td align="center"></td><td align="center"></td><td align="center"></td></tr>
<tr><td>11. Output execution report.</td><td align="center"></td><td align="center"></td><td align="center"></td><td align="center">✔️</td></tr>
</tbody></table>
<h1><a class="header" href="#information-flow" id="information-flow">Information Flow</a></h1>
<p><img src="asynchronous_design/information_flow_information_flow_graph_0.generated.svg" alt="" title="Information Flow Graph" /></p>
<ul>
<li>
<p>Step 1, 2, 3, and 4 are done synchronously, so are not executed concurrently / in parallel.</p>
</li>
<li>
<p>The dashed lines indicate passing data to tasks in a different category. This may take the form of:</p>
<ul>
<li>
<p><strong><code>async</code> function call:</strong></p>
<p>When a new instance of the task may be spawned each time.</p>
<pre><code class="language-rust edition2018 ignore">pub struct Web(pub Credentials);
impl Web {
    pub async fn retrieve_info(&amp;self, _: &amp;Record) -&gt; PropertyInfo { .. }
}

// Invoked like so:
web.retrieve_info(record).await;
</code></pre>
</li>
<li>
<p><strong>Channel Send/Receive:</strong></p>
<p>When it is not possible to spawn multiple instances of the task, we use a long-lived task with a channel to receive data.</p>
<pre><code class="language-rust edition2018 ignore">pub struct Reporter {
<span class="boring">    pub progress_receiver: Receiver&lt;ProgressUpdate&gt;,
</span>    pub report: Report,
<span class="boring">    progress_overall: ProgressBar,
</span>}
impl Reporter {
    pub async fn update(&amp;mut self) {
        // When receiving a progress update from the channel.
<span class="boring">        while let Some(process_result) = self.progress_receiver.recv().await {
</span><span class="boring">            match process_result {
</span><span class="boring">                PropertyInfoResult::Success =&gt; {
</span>        self.report.record_processed_successful_count += 1;
<span class="boring">                }
</span><span class="boring">                // ..
</span><span class="boring">            }
</span><span class="boring">            self.progress_overall.inc(1);
</span><span class="boring">        }
</span>    }
}

// Cannot do this per record because of `&amp;mut self`:
reporter.update(process_result).await;

// Have to do this instead:
progress_channel.send(process_result);
</code></pre>
</li>
</ul>
</li>
</ul>
<h1><a class="header" href="#comparison" id="comparison">Comparison</a></h1>
<table><thead><tr><th>Item</th><th>Synchronous</th><th>Asynchronous</th></tr></thead><tbody>
<tr><td>Logic Network</td><td>Simple network of complex tasks</td><td>Complex network of simple tasks</td></tr>
<tr><td>Effort For Efficiency</td><td>Explicitly managed</td><td>Natually enforced by the code</td></tr>
<tr><td>Library Availability / Maturity</td><td>Generally exist</td><td>Generally do not exist</td></tr>
</tbody></table>
<p></p>
<details>
<summary><b>Logic Network</b></summary>
<ul>
<li>
<p><strong>sync:</strong> Simple network of complex tasks</p>
<p><img src="comparison_logic_network_synchronous_0.generated.svg" alt="" title="Logic Network Synchronous" /></p>
</li>
<li>
<p><strong>async:</strong> Complex network of simple tasks</p>
<p><img src="comparison_logic_network_asynchronous_1.generated.svg" alt="" title="Logic Network Asynchronous" /></p>
</li>
</ul>
</details>
<h1><a class="header" href="#review" id="review">Review</a></h1>
<ul>
<li>Good UX can be implemented in both synchronous and asynchronous paradigms.</li>
<li>It's worth spending time to design an async application before implementation.</li>
<li>Rust's async ecosystem is still in its early days, but is promising.</li>
</ul>
<h1><a class="header" href="#links" id="links">Links</a></h1>
<ul>
<li><a href="https://rust-lang.github.io/async-book/">Rust Async Book</a></li>
<li><a href="https://cfsamson.github.io/book-exploring-async-basics/introduction.html">Exploring Async Basics</a> by CF Samson</li>
<li><a href="https://crates.io/crates/async-std"><code>async-std</code></a></li>
<li><a href="https://crates.io/crates/tokio"><code>tokio</code></a></li>
<li><a href="https://github.com/azriel91/cli_async"><code>cli_async</code></a>: Stub CLI application repository.</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        

                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                

                
            </nav>

        </div>

        

        

        
        
        
        <script type="text/javascript">
            window.playpen_copyable = true;
        </script>
        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        
        
        <script type="text/javascript">
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>
        
        

    </body>
</html>
